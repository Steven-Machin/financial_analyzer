<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Personal Finance Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f6f7fb;
      color: #222;
    }
    body { margin: 0; }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    input[type="password"],
    input[type="file"],
    select,
    textarea {
      color: #111827;
      background-color: #fff;
    }
    select option {
      color: #111827;
      background-color: #fff;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 4rem;
    }
    header h1 {
      margin: 0 0 0.25rem;
      font-size: 2.2rem;
    }
    header p {
      margin: 0;
      color: #555;
    }
    .inputs-note {
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }
    .user-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: #eef1fb;
      border-radius: 12px;
    }
    .user-bar span {
      font-weight: 600;
      color: #1f2937;
    }
    .user-bar form {
      margin: 0;
    }
    .pagination-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 1.2rem;
    }
    .pagination-info {
      font-size: 0.9rem;
      color: #4b5563;
    }
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .pagination-controls form {
      margin: 0;
    }
    .per-page-form {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .per-page-form select {
      min-width: 80px;
    }
    .pagination-controls button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .page-status {
      font-weight: 600;
      color: #1f2937;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      margin: 1.5rem 0 2.5rem;
    }
    .filter-form {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 1.5rem;
      align-items: flex-end;
      background: #fff;
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
    }
    .filter-form fieldset {
      border: none;
      margin: 0;
      padding: 0;
      min-width: 160px;
    }
    .filter-form legend,
    .filter-label {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #52607c;
      margin-bottom: 0.35rem;
      display: block;
    }
    .filter-form select,
    .filter-form input[type="date"],
    .filter-form input[type="text"] {
      border: 1px solid #cbd2ea;
      border-radius: 8px;
      padding: 0.55rem 0.65rem;
      font-size: 0.95rem;
      background: #fff;
      color: #111827;
      min-width: 160px;
    }
    .range-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .range-buttons button {
      border: 1px solid #cbd2ea;
      background: #fff;
      color: #2a3d66;
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .range-buttons button:hover {
      background: #2a3d66;
      color: #fff;
    }
    .range-buttons button.active {
      background: #365feb;
      border-color: #365feb;
      color: #fff;
      box-shadow: 0 6px 20px rgba(54, 95, 235, 0.25);
    }
    .date-inputs {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .date-inputs .field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .date-inputs small {
      font-size: 0.75rem;
      color: #6b7285;
    }
    .data-entry {
      margin-bottom: 3rem;
    }
    .form-errors {
      background: #ffe8e6;
      border: 1px solid #f5b1ac;
      color: #8a1f17;
      border-radius: 8px;
      padding: 0.85rem 1.1rem;
      margin-bottom: 1.2rem;
    }
    .form-errors ul {
      margin: 0;
      padding-left: 1.2rem;
    }
    .entry-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
      padding: 1.6rem;
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 0.6rem;
      font-size: 1.4rem;
    }
    .card p {
      margin-top: 0;
      color: #6b7285;
      font-size: 0.95rem;
    }
    .transaction-form,
    .budget-form,
    .account-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      align-items: end;
      margin-top: 1.1rem;
    }
    .transaction-form .field,
    .budget-form .field,
    .account-form .field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .transaction-form label,
    .budget-form label,
    .account-form label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #52607c;
    }
    .transaction-form input,
    .transaction-form select,
    .budget-form input,
    .account-form input,
    .account-form select {
      border: 1px solid #cbd2ea;
      border-radius: 8px;
      padding: 0.55rem 0.65rem;
      font-size: 0.95rem;
      background: #fff;
      color: #111827;
    }
    .import-card form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 0;
    }
    .import-card .field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .import-card .primary-button,
    .import-card .secondary-button {
      width: 100%;
      text-align: center;
      padding: 0.7rem 1.3rem;
    }
    .primary-button {
      border: none;
      background: #365feb;
      color: #fff;
      padding: 0.7rem 1.3rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
      box-shadow: 0 10px 28px rgba(54, 95, 235, 0.25);
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }
    .primary-button:hover {
      background: #2a3d66;
      box-shadow: 0 14px 32px rgba(42, 61, 102, 0.35);
    }
    .secondary-button,
    .danger-button,
    .link-button {
      border: 1px solid #cbd2ea;
      background: #fff;
      color: #2a3d66;
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    .secondary-button:hover {
      background: #f0f4ff;
    }
    .danger-button {
      border-color: #f87171;
      color: #c81e1e;
    }
    .danger-button:hover {
      background: #fef2f2;
    }
    .link-button {
      border: none;
      padding: 0;
      background: none;
      color: #c81e1e;
    }
    .link-button:hover {
      text-decoration: underline;
    }
    .import-actions {
      margin-top: 1.75rem;
    }
    .import-actions form {
      margin: 0;
    }
    .export-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin: 1.25rem 0 1.75rem;
    }
    .export-actions form {
      margin: 0;
    }
    .account-list {
      margin-top: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }
    .account-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.8rem;
      border: 1px solid #e4e7f5;
      border-radius: 8px;
      background: #f9faff;
    }
    .account-list-item span {
      font-weight: 600;
    }
    .account-list-item small {
      color: #6b7285;
      font-size: 0.8rem;
    }
    .accounts-summary {
      margin-bottom: 3rem;
    }
    .accounts-summary .totals {
      margin-bottom: 1.5rem;
    }
    .accounts-table {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
      padding: 1.3rem 1.5rem 1.6rem;
    }
    .accounts-table table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .accounts-table th,
    .accounts-table td {
      padding: 0.65rem 0.8rem;
      text-align: left;
      font-size: 0.9rem;
    }
    .accounts-table thead {
      background: #eef1fb;
    }
    .accounts-table tbody tr:nth-child(even) {
      background: #f8f9fe;
    }
    .account-row.is-selected {
      background: #f0f5ff;
    }
    .transaction-table {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
      padding: 1.4rem 1.6rem 1.6rem;
      margin-bottom: 3rem;
    }
    .transaction-table h2 {
      margin-top: 0;
      font-size: 1.4rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    table thead {
      background: #eef1fb;
    }
    table th,
    table td {
      padding: 0.7rem 0.9rem;
      text-align: left;
      font-size: 0.95rem;
    }
    table tbody tr:nth-child(even) {
      background: #f8f9fe;
    }
    table td.actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
    }
    .inline-form {
      display: inline;
    }
    .edit-link {
      color: #365feb;
      font-weight: 600;
      text-decoration: none;
    }
    .edit-link:hover {
      text-decoration: underline;
    }
    .type.income {
      color: #0b8235;
      font-weight: 600;
    }
    .type.expense {
      color: #b91c1c;
      font-weight: 600;
    }
    .progress-track {
      width: 100%;
      height: 10px;
      background: #e0e7ff;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #365feb, #5c7dff);
    }
    .budgets-overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
    }
    .budget-card {
      background: #fff;
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .budget-card h3 {
      margin: 0;
      font-size: 1.05rem;
      color: #1f2937;
    }
    .budget-amount {
      font-weight: 600;
      font-size: 1.05rem;
      color: #111827;
    }
    .budget-amount span {
      color: #6b7285;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .budget-progress {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .budget-progress-track {
      flex: 1;
      height: 12px;
      border-radius: 999px;
      background: #e0e7ff;
      overflow: hidden;
    }
    .budget-progress-fill {
      height: 100%;
      transition: width 0.35s ease;
    }
    .budget-progress-fill.ok {
      background: linear-gradient(90deg, #0f9d58, #34d399);
    }
    .budget-progress-fill.warn {
      background: linear-gradient(90deg, #facc15, #f59e0b);
    }
    .budget-progress-fill.over {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }
    .budget-progress-percent {
      font-weight: 600;
      min-width: 3.5rem;
      text-align: right;
      color: #1f2937;
    }
    @media (max-width: 640px) {
      .budget-progress {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }
      .budget-progress-percent {
        text-align: left;
      }
    }
    .budget-row.over td {
      background: #fef2f2;
      color: #991b1b;
    }
    .budget-row.over .progress-fill {
      background: linear-gradient(90deg, #f97316, #ef4444);
    }
    section {
      margin: 3rem 0;
    }
    section h2 {
      margin-bottom: 0.8rem;
      font-size: 1.6rem;
      border-bottom: 2px solid #eceef5;
      padding-bottom: 0.5rem;
    }
    .section-help {
      margin-top: 0;
      margin-bottom: 1.25rem;
      color: #6b7285;
      font-size: 0.95rem;
    }
    .totals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.2rem;
      margin-bottom: 2rem;
    }
    .totals .card {
      padding: 1.4rem 1.6rem;
    }
    .totals .card h3 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7285;
    }
    .totals .card strong {
      font-size: 1.7rem;
      display: block;
    }
    .chart-card {
      position: relative;
      height: 360px;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.06);
      margin-bottom: 1.5rem;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    @media (max-width: 720px) {
      .controls {
        gap: 1.5rem;
      }
      .filter-form {
        padding: 1rem 1.1rem;
      }
      .transaction-form,
      .budget-form,
      .account-form {
        grid-template-columns: 1fr;
      }
      .pagination-bar {
        align-items: flex-start;
      }
      .pagination-controls {
        flex-wrap: wrap;
        justify-content: flex-start;
      }
      table td.actions {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="page">
    <header>
      <h1>Personal Finance Analyzer</h1>
      <p class="inputs-note">Currently analyzing: {{ data_source_label }}</p>
      <div class="user-bar">
        <span>Logged in as {{ user.username }}</span>
        <form method="post" action="{{ url_for('logout') }}" data-no-scroll="true">
          <button type="submit" class="secondary-button">Log Out</button>
        </form>
      </div>
      <div class="controls">
        <form class="filter-form" method="get">
          {% for path in inputs %}
          <input type="hidden" name="input" value="{{ path }}">
          {% endfor %}
          <div class="filter-group">
            <span class="filter-label">Category</span>
            <select name="category" onchange="this.form.submit()">
              <option value="all" {% if filters.category == 'all' %}selected{% endif %}>All categories</option>
              {% for cat in available_categories %}
              <option value="{{ cat }}" {% if filters.category == cat %}selected{% endif %}>{{ cat }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <span class="filter-label">Account</span>
            <select name="account" onchange="this.form.submit()">
              <option value="all" {% if filters.account == 'all' %}selected{% endif %}>All accounts</option>
              {% for acct in available_accounts %}
              <option value="{{ acct }}" {% if filters.account == acct %}selected{% endif %}>{{ acct }}</option>
              {% endfor %}
            </select>
          </div>
          <fieldset>
            <legend>Quick Range</legend>
            <div class="range-buttons">
              {% for value, label in range_options %}
              <button type="submit" name="range" value="{{ value }}" class="{% if filters.range == value %}active{% endif %}">{{ label }}</button>
              {% endfor %}
            </div>
          </fieldset>
          <div class="date-inputs">
            <div class="field">
              <label class="filter-label" for="start-date">Start</label>
              <input id="start-date" type="date" name="start" value="{{ filter_state.start }}">
            </div>
            <div class="field">
              <label class="filter-label" for="end-date">End</label>
              <input id="end-date" type="date" name="end" value="{{ filter_state.end }}">
            </div>
            <div class="field" style="min-width:160px;">
              <button type="submit" class="secondary-button">Apply Filters</button>
              <small>Custom dates apply when the range is set to Custom.</small>
            </div>
          </div>
          <input type="hidden" name="page" value="1">
        </form>
      </div>
    </header>

    <section class="data-entry" id="data-entry">
      {% if errors %}
      <div class="form-errors" role="alert">
        <ul>
          {% for message in errors %}
          <li>{{ message }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      <div class="entry-grid">
        <div class="card manual-card">
          <h2>{% if form_mode == 'edit' %}Edit Transaction{% else %}Add Transaction{% endif %}</h2>
          <p>Capture spending or income manually. Transactions are stored in your browser session.</p>
          <form class="transaction-form" method="post" autocomplete="off">
            <input type="hidden" name="action" value="{% if form_mode == 'edit' %}save_edit{% else %}add_manual{% endif %}">
            {% if form_mode == 'edit' and edit_id %}
            <input type="hidden" name="transaction_id" value="{{ edit_id }}">
            {% endif %}
            {% for path in inputs %}
            <input type="hidden" name="input" value="{{ path }}">
            {% endfor %}
            {% for name, value in filter_state.items() %}
            <input type="hidden" name="{{ name }}" value="{{ value }}">
            {% endfor %}
            <input type="hidden" name="page" value="{{ pagination.current_page }}">
            <div class="field">
              <label for="txn-date">Date</label>
              <input id="txn-date" type="date" name="date" value="{{ manual_form.date }}" required>
            </div>
            <div class="field">
              <label for="txn-description">Description</label>
              <input id="txn-description" type="text" name="description" value="{{ manual_form.description }}" placeholder="Groceries, rent, utilities..." required>
            </div>
            <div class="field">
              <label for="txn-kind">Type</label>
              <select id="txn-kind" name="kind">
                <option value="expense" {% if manual_form.kind != 'income' %}selected{% endif %}>Expense</option>
                <option value="income" {% if manual_form.kind == 'income' %}selected{% endif %}>Income</option>
              </select>
            </div>
            <div class="field">
              <label for="txn-amount">Amount</label>
              <input id="txn-amount" type="number" step="0.01" min="0" name="amount" value="{{ manual_form.amount }}" placeholder="0.00" required>
            </div>
            <div class="field">
              <label for="txn-account">Account</label>
              <select id="txn-account" name="account">
                {% for account in accounts_list %}
                <option value="{{ account }}" {% if manual_form.account == account %}selected{% endif %}>{{ account }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field">
              <button type="submit" class="primary-button">{% if form_mode == 'edit' %}Save Changes{% else %}Add Transaction{% endif %}</button>
              {% if form_mode == 'edit' %}
              <a class="secondary-button" href="{{ cancel_edit_url }}">Cancel</a>
              {% endif %}
            </div>
          </form>
        </div>
        <div class="card import-card">
          <h2>Import CSV</h2>
          <p>Upload bank exports to analyze instantly. We detect common headers automatically.</p>
          <form method="post" enctype="multipart/form-data">
            <input type="hidden" name="action" value="upload_csv">
            {% for path in inputs %}
            <input type="hidden" name="input" value="{{ path }}">
            {% endfor %}
            {% for name, value in filter_state.items() %}
            <input type="hidden" name="{{ name }}" value="{{ value }}">
            {% endfor %}
            <input type="hidden" name="page" value="{{ pagination.current_page }}">
            <div class="field">
              <label class="filter-label" for="csv-file">CSV File</label>
              <input id="csv-file" type="file" name="csv_file" accept=".csv" required>
            </div>
            <div class="field">
              <label for="upload-account">Assign Missing Accounts</label>
              <select id="upload-account" name="upload_account">
                <option value="detect" {% if upload_account_choice == 'detect' %}selected{% endif %}>Use CSV data or Checking</option>
                {% for account in accounts_list %}
                <option value="{{ account }}" {% if upload_account_choice == account %}selected{% endif %}>Assign to {{ account }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field">
              <button type="submit" class="primary-button">Import Transactions</button>
            </div>
          </form>
          <div class="import-actions">
            <form method="post">
              <input type="hidden" name="action" value="clear_transactions">
              {% for path in inputs %}
              <input type="hidden" name="input" value="{{ path }}">
              {% endfor %}
              {% for name, value in filter_state.items() %}
              <input type="hidden" name="{{ name }}" value="{{ value }}">
              {% endfor %}
              <input type="hidden" name="page" value="{{ pagination.current_page }}">
              <button type="submit" class="secondary-button">Clear Session Transactions</button>
            </form>
          </div>
        </div>
        <div class="card budget-card">
          <h2>Budgets</h2>
          <p>Track monthly limits by category. These combine with any defaults from configuration.</p>
          <form class="budget-form" method="post">
            <input type="hidden" name="action" value="add_budget">
            {% for path in inputs %}
            <input type="hidden" name="input" value="{{ path }}">
            {% endfor %}
            {% for name, value in filter_state.items() %}
            <input type="hidden" name="{{ name }}" value="{{ value }}">
            {% endfor %}
            <input type="hidden" name="page" value="{{ pagination.current_page }}">
            <div class="field">
              <label for="budget-category">Category</label>
              <input id="budget-category" type="text" name="budget_category" value="{{ budget_form.category }}" placeholder="e.g. Groceries" required>
            </div>
            <div class="field">
              <label for="budget-limit">Monthly Limit</label>
              <input id="budget-limit" type="number" step="0.01" min="0" name="budget_limit" value="{{ budget_form.limit }}" placeholder="0.00" required>
            </div>
            <div class="field">
              <button type="submit" class="primary-button">Save Budget</button>
            </div>
          </form>
        </div>
        <div class="card accounts-card">
          <h2>Accounts</h2>
          <p>Organize the accounts used for manual entries and imports. Remove accounts with no transactions.</p>
          <form class="account-form" method="post">
            <input type="hidden" name="action" value="add_account">
            {% for path in inputs %}
            <input type="hidden" name="input" value="{{ path }}">
            {% endfor %}
            {% for name, value in filter_state.items() %}
            <input type="hidden" name="{{ name }}" value="{{ value }}">
            {% endfor %}
            <input type="hidden" name="page" value="{{ pagination.current_page }}">
            <div class="field">
              <label for="account-name">Account Name</label>
              <input id="account-name" type="text" name="account_name" placeholder="Checking, Savings, Credit Card" required>
            </div>
            <div class="field">
              <button type="submit" class="primary-button">Add Account</button>
            </div>
          </form>
          <div class="account-list">
            {% for account in account_management %}
            <div class="account-list-item">
              <div>
                <span>{{ account.name }}</span>
                {% if account.in_use %}
                <small>In use</small>
                {% endif %}
              </div>
              {% if account.can_delete %}
              <form method="post" class="inline-form">
                <input type="hidden" name="action" value="delete_account">
                <input type="hidden" name="account_name" value="{{ account.name }}">
                {% for path in inputs %}
                <input type="hidden" name="input" value="{{ path }}">
                {% endfor %}
                {% for name, value in filter_state.items() %}
                <input type="hidden" name="{{ name }}" value="{{ value }}">
                {% endfor %}
                <input type="hidden" name="page" value="{{ pagination.current_page }}">
                <button type="submit" class="link-button">Delete</button>
              </form>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <section class="accounts-summary" id="accounts">
      <h2>Accounts Overview</h2>
      <p class="section-help">Totals combine all data, while the current view reflects filters like range and account selection.</p>
      <div class="totals accounts-totals">
        <div class="card">
          <h3>All Accounts Income</h3>
          <strong>${{ '%0.2f'|format(overall_totals_all.income) }}</strong>
        </div>
        <div class="card">
          <h3>All Accounts Expenses</h3>
          <strong>${{ '%0.2f'|format(overall_totals_all.expense) }}</strong>
        </div>
        <div class="card">
          <h3>All Accounts Net</h3>
          <strong>${{ '%0.2f'|format(overall_totals_all.net) }}</strong>
        </div>
      </div>
      <div class="accounts-table">
        <table aria-label="Account balances">
          <thead>
            <tr><th>Account</th><th>Income (All)</th><th>Expense (All)</th><th>Net (All)</th><th>Income (View)</th><th>Expense (View)</th><th>Net (View)</th></tr>
          </thead>
          <tbody>
            {% for row in account_rows %}
            <tr class="account-row{% if row.is_selected %} is-selected{% endif %}">
              <td>{{ row.name }}</td>
              <td>${{ '%0.2f'|format(row.all_income) }}</td>
              <td>${{ '%0.2f'|format(row.all_expense) }}</td>
              <td>${{ '%0.2f'|format(row.all_net) }}</td>
              <td>{% if row.view_income is not none %}${{ '%0.2f'|format(row.view_income) }}{% else %}--{% endif %}</td>
              <td>{% if row.view_expense is not none %}${{ '%0.2f'|format(row.view_expense) }}{% else %}--{% endif %}</td>
              <td>{% if row.view_net is not none %}${{ '%0.2f'|format(row.view_net) }}{% else %}--{% endif %}</td>
            </tr>
            {% else %}
            <tr><td colspan="7">No account activity yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="transaction-table" id="transactions">
      <h2>Transactions</h2>
      <p class="section-help">Filtered view: {{ range_label|lower }}{% if filters.category != 'all' %}, category {{ filters.category }}{% endif %}{% if filters.account != 'all' %}, account {{ filters.account }}{% endif %}.</p>
      <table aria-label="Transactions">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Category</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Account</th>
            <th>Source</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for txn in transaction_rows %}
          <tr>
            <td>{{ txn.date }}</td>
            <td>{{ txn.description }}</td>
            <td>{{ txn.category }}</td>
            <td class="type {{ txn.kind }}">{% if txn.kind == 'income' %}Income{% else %}Expense{% endif %}</td>
            <td>{% if txn.kind == 'expense' %}-{% endif %}${{ '%0.2f'|format(txn.amount) }}</td>
            <td>{{ txn.account if txn.account else '--' }}</td>
            <td>{{ txn.source|capitalize }}</td>
            <td class="actions">
              <a class="edit-link" href="{{ txn.edit_url }}">Edit</a>
              <form method="post" class="inline-form">
                <input type="hidden" name="action" value="delete_transaction">
                <input type="hidden" name="transaction_id" value="{{ txn.id }}">
                {% for path in inputs %}
                <input type="hidden" name="input" value="{{ path }}">
                {% endfor %}
                {% for name, value in filter_state.items() %}
                <input type="hidden" name="{{ name }}" value="{{ value }}">
                {% endfor %}
                <input type="hidden" name="page" value="{{ pagination.current_page }}">
                <button type="submit" class="link-button">Delete</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="8">No transactions match the current filters.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination-bar">
        <div class="pagination-info">
          {% if pagination.total_transactions %}
          Showing {{ pagination.start_display }}-{{ pagination.end_display }} of {{ pagination.total_transactions }} transactions
          {% else %}
          No transactions to display
          {% endif %}
        </div>
        <div class="pagination-controls">
          {% if pagination.has_prev %}
          <form method="get" action="{{ url_for('index') }}">
            {% for name, value in filter_state.items() %}
            <input type="hidden" name="{{ name }}" value="{{ value }}">
            {% endfor %}
            <input type="hidden" name="page" value="{{ pagination.prev_page }}">
            <button type="submit" class="secondary-button">Previous</button>
          </form>
          {% else %}
          <button class="secondary-button" disabled>Previous</button>
          {% endif %}
          <span class="page-status">Page {{ pagination.current_page }} of {{ pagination.total_pages }}</span>
          <form method="get" class="per-page-form" action="{{ url_for('index') }}">
            {% for name, value in filter_state.items() %}
            {% if name != 'per_page' %}
            <input type="hidden" name="{{ name }}" value="{{ value }}">
            {% endif %}
            {% endfor %}
            <input type="hidden" name="page" value="1">
            <label class="filter-label" for="per-page-select">Rows</label>
            <select id="per-page-select" name="per_page" onchange="this.form.submit()">
              {% for option in per_page_options %}
              <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </form>
          {% if pagination.has_next %}
          <form method="get" action="{{ url_for('index') }}">
            {% for name, value in filter_state.items() %}
            <input type="hidden" name="{{ name }}" value="{{ value }}">
            {% endfor %}
            <input type="hidden" name="page" value="{{ pagination.next_page }}">
            <button type="submit" class="secondary-button">Next</button>
          </form>
          {% else %}
          <button class="secondary-button" disabled>Next</button>
          {% endif %}
        </div>
      </div>
    </section>

    <section id="overview">
      <h2>Spending Overview</h2>
      <p class="section-help">Snapshot for {{ range_label|lower }} covering income, expenses, and category trends.</p>
      <div class="export-actions">
        <form method="get" action="{{ url_for('export_summary_csv_view') }}">
          {% for name, value in filter_state.items() %}
          <input type="hidden" name="{{ name }}" value="{{ value }}">
          {% endfor %}
          <button type="submit" class="primary-button">Export CSV</button>
        </form>
        <form method="get" action="{{ url_for('export_summary_json_view') }}">
          {% for name, value in filter_state.items() %}
          <input type="hidden" name="{{ name }}" value="{{ value }}">
          {% endfor %}
          <button type="submit" class="secondary-button">Export JSON</button>
        </form>
      </div>
      <div class="totals">
        <div class="card">
          <h3>Income</h3>
          <strong>${{ '%0.2f'|format(summary.totals.income) }}</strong>
        </div>
        <div class="card">
          <h3>Expenses</h3>
          <strong>${{ '%0.2f'|format(summary.totals.expense) }}</strong>
        </div>
        <div class="card">
          <h3>Net</h3>
          <strong>${{ '%0.2f'|format(summary.totals.net) }}</strong>
        </div>
      </div>
      <div class="chart-card">
        <canvas id="categoryChart"></canvas>
      </div>
      <table aria-label="Spend by category">
        <thead>
          <tr><th>Category</th><th>Amount</th></tr>
        </thead>
        <tbody>
          {% for cat, amt in summary.category_spend.items() %}
          <tr><td>{{ cat }}</td><td>${{ '%0.2f'|format(amt) }}</td></tr>
          {% else %}
          <tr><td colspan="2">No categorized spending yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    {% if summary.budget_usage %}
    <section id="budgets-overview">
      <h2>Budgets Overview</h2>
      <p class="section-help">See how each budget category is tracking in this view.</p>
      <div class="budgets-overview-grid">
        {% for entry in summary.budget_usage %}
        {% set percent = entry.percent_used %}
        {% set fill_class = 'ok' %}
        {% if percent >= 100 %}
          {% set fill_class = 'over' %}
        {% elif percent >= 75 %}
          {% set fill_class = 'warn' %}
        {% endif %}
        {% set fill_width = percent %}
        {% if fill_width < 0 %}
          {% set fill_width = 0 %}
        {% elif fill_width > 150 %}
          {% set fill_width = 150 %}
        {% endif %}
        <article class="budget-card">
          <h3>{{ entry.category }}</h3>
          <div class="budget-amount">${{ '%0.2f'|format(entry.spent) }} <span>/ ${{ '%0.2f'|format(entry.limit) }}</span></div>
          <div class="budget-progress">
            <div class="budget-progress-track">
              <div class="budget-progress-fill {{ fill_class }}" style="width: {{ '%0.1f'|format(fill_width) }}%;"></div>
            </div>
            <div class="budget-progress-percent">{{ '%0.1f'|format(percent) }}%</div>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <section id="monthly">
      <h2>Monthly Totals</h2>
      <p class="section-help">Track inflows and outflows month-to-month to spot seasonal shifts.</p>
      <table aria-label="Monthly totals">
        <thead>
          <tr><th>Month</th><th>Income</th><th>Expense</th><th>Net</th></tr>
        </thead>
        <tbody>
          {% for month, vals in summary.monthly.items() %}
          <tr>
            <td>{{ month }}</td>
            <td>${{ '%0.2f'|format(vals.income) }}</td>
            <td>${{ '%0.2f'|format(vals.expense) }}</td>
            <td>${{ '%0.2f'|format(vals.net) }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4">No monthly data available.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    {% if budget_rows %}
    <section id="budget">
      <h2>Budget Status</h2>
      <p class="section-help">Compare actual spending against monthly limits. Categories above 100% are highlighted.</p>
      <table aria-label="Budget status">
        <thead>
          <tr><th>Category</th><th>Limit</th><th>Actual</th><th>Remaining</th><th>Progress</th><th></th></tr>
        </thead>
        <tbody>
          {% for row in budget_rows %}
          <tr class="budget-row{% if row.over %} over{% endif %}">
            <td>{{ row.category }}</td>
            <td>{% if row.limit is not none %}${{ '%0.2f'|format(row.limit) }}{% else %}--{% endif %}</td>
            <td>{% if row.actual is not none %}${{ '%0.2f'|format(row.actual) }}{% else %}--{% endif %}</td>
            <td>{% if row.remaining is not none %}${{ '%0.2f'|format(row.remaining) }}{% else %}--{% endif %}</td>
            <td style="min-width: 140px;">
              <div class="progress-track">
                <div class="progress-fill" style="width: {{ row.progress }}%;"></div>
              </div>
              <small>{{ row.progress }}%</small>
            </td>
            <td>
              {% if row.editable %}
              <form method="post">
                <input type="hidden" name="action" value="remove_budget">
                <input type="hidden" name="budget_category" value="{{ row.category }}">
                {% for path in inputs %}
                <input type="hidden" name="input" value="{{ path }}">
                {% endfor %}
                {% for name, value in filter_state.items() %}
                <input type="hidden" name="{{ name }}" value="{{ value }}">
                {% endfor %}
                <button type="submit" class="link-button">Remove</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6">No budgets configured yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
    {% endif %}

    <section id="top-purchases">
      <h2>Top Purchases</h2>
      <p class="section-help">Largest spends in {{ range_label|lower }} to highlight where money is going.</p>
      <table aria-label="Top purchases">
        <thead>
          <tr><th>Merchant / Description</th><th>Spend</th></tr>
        </thead>
        <tbody>
          {% for desc, amt in summary.top_merchants %}
          <tr><td>{{ desc }}</td><td>${{ '%0.2f'|format(amt) }}</td></tr>
          {% else %}
          <tr><td colspan="2">No purchases ranked yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section id="recurring">
      <h2>Recurring Payments</h2>
      <p class="section-help">Payments that repeat across months help you spot subscriptions quickly.</p>
      <table aria-label="Recurring payments">
        <thead>
          <tr><th>Description</th><th>Typical Amount</th><th>Months Seen</th></tr>
        </thead>
        <tbody>
          {% for desc, amt, months in summary.recurring %}
          <tr><td>{{ desc }}</td><td>${{ '%0.2f'|format(amt) }}</td><td>{{ months }}</td></tr>
          {% else %}
          <tr><td colspan="3">No recurring payments detected.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </div>

  <script>
    const summary = {{ summary | tojson }};
    const chartTitle = {{ chart_title | tojson }};
    if (summary.category_spend && Object.keys(summary.category_spend).length) {
      const labels = Object.keys(summary.category_spend);
      const data = Object.values(summary.category_spend);
      const canvas = document.getElementById('categoryChart');
      const ctx = canvas.getContext('2d');
      canvas.height = 360;
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Spend ($)',
            data,
            borderRadius: 8,
            backgroundColor: 'rgba(54, 99, 235, 0.65)',
            hoverBackgroundColor: 'rgba(54, 99, 235, 0.85)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            title: { display: true, text: chartTitle },
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `$${ctx.parsed.y.toFixed(2)}` } }
          },
          scales: {
            x: { title: { display: true, text: 'Category' } },
            y: { beginAtZero: true, title: { display: true, text: 'Amount ($)' } }
          }
        }
      });
    }
    const SCROLL_KEY = 'pfa:scrollY';
    document.querySelectorAll('form').forEach(form => {
      if (form.dataset.noScroll === 'true') {
        return;
      }
      form.addEventListener('submit', () => {
        sessionStorage.setItem(SCROLL_KEY, String(window.scrollY || window.pageYOffset || 0));
      });
    });
    const storedScroll = sessionStorage.getItem(SCROLL_KEY);
    if (storedScroll !== null) {
      sessionStorage.removeItem(SCROLL_KEY);
      const offset = parseInt(storedScroll, 10);
      if (!Number.isNaN(offset)) {
        window.scrollTo({ top: offset, behavior: 'auto' });
      }
    }
  </script>
</body>
</html>
